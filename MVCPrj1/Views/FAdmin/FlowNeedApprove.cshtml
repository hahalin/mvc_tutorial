@model  MVCPrj1.Models.viewModel.vwFlowStatus
@using MVCPrj1.Models
@{
    var mdsub = Model.StatusSub;
}


<div class="row">
    </br>
</div>
<div class="row">
    <div id="toolbar"></div>
</div>

<div class="row" id="container">



</div>
@Html.Partial("FlowSignForm")


<script src="~/Scripts/Flow/CheckForm.bundle.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        //alert('jq ready');
        return;
        var param = new Object();
        param.co = '0';
        param.uid = 'T000165';
        //http://blog.darkthread.net/post-2010-04-21-asp-net-json.aspx
        //http://codepaste.net/hjwiet
        function showSignFormWin(data) {
            var json = JSON.stringifyWcf(data);
            var m2 = JSON.parseWithDate(json);
            $('#fma-tab1 form').empty('');
            $('#fma').attr('form_id', data.form_id);
            $('#fma').attr('co_code', data.co_code);
            $('#fma .modal-title').text('審核表單');
            if ($('#fma .modal-title').parent().find('.formname').length == 0) {
                $('#fma .modal-title').after('<label class="formname text-info"></label>');
            }
            $('#fma .formname').text(data.form_name);
            $('#fma .title-data').text('')
            .append(
            '<label>申請人姓名：</label>' + data.usr_name
            + '  <label>申請人職稱：</label>' + data.usr_title
            + '</br>'
            + '<label>申請人部門：</label>' + data.dep_name
            + '  <label>申請日期：</label>' + m2.apply_time.toLocaleString()
            )
            ;
            //fma-表單本文
            var form_id = data.form_id;
            var co_code = data.co_code;
            var seq_no = data.seq_no;
            $.ajax({
                method: 'POST',
                data: { form_id: form_id, co_code: co_code, seq_no: seq_no },
                url: '@Url.Action("getFormBasic", "FAdmin")',
                dataType: 'json',
                success: function (r) {
                    var define = r.define;
                    var data = r.data;
                    $.each(define, function (index, item) {
                        var row = item.row;
                        if ($('#fma-tab1 form .form-group:nth-child(' + row + ')').length == 0) {
                            $('#fma-tab1 form').append('<div class="form-group"></div>');
                        }
                    });
                    $.each(define, function (index, item) {
                        if (item.ctl_type == 'SELECT') {
                            item.ctl_type = 'INPUT';
                        }
                        var fd = document.createElement(item.ctl_type);
                        var label = null;
                        if (item.ctl_type == 'TEXTAREA') {
                            $(fd).attr('rows', 6);
                        }
                        if (item.ctl_remark.length <= 1) {
                        }
                        else {
                            label = document.createElement('label');
                            $(label).text(item.ctl_remark);
                            $(label).addClass('control-label');
                            $(label).addClass('col-xs-1');
                            $(label).css('width', '100px');
                        }
                        var div = $('#fma-tab1 form .form-group:nth-child(' + item.row + ')');
                        if (label != null) {
                            $(div).append(label);
                        }
                        var exprop = JSON.parse(item.exprop);
                        if (exprop != null) {
                            $(fd).css('width', '50px').css('text-align', 'right');
                            var cdiv;
                            var gp = exprop.group;
                            if ($(div).children("div[group='" + gp + "']").length == 0) {
                                cdiv = document.createElement('div');
                                $(cdiv).addClass('col-sm-6').attr('group', gp);
                                $(div).append(cdiv);
                            }
                            else {
                                cdiv = $(div).children("div[group='" + gp + "']");
                            }
                            $(cdiv).append(fd);
                            $(fd).after('<span style="width:30px;display:inline-block;">' + exprop.postlabel + '</span>');
                        }
                        else {
                            $(fd).addClass('form-control');
                            $(fd).addClass('col-sm-' + item.size);
                            var cdiv = document.createElement('div');
                            $(div).append(cdiv);
                            $(cdiv).addClass('col-sm-' + item.size);
                            $(cdiv).append(fd);
                        }
                        $.each(data, function (dindex, ditem) {
                            if (ditem.ctl_id == item.ctl_id) {
                                if (item.ctl_type == 'LABEL') {
                                    $(fd).text(ditem.ctl_value);
                                }
                                else {
                                    $(fd).val(ditem.ctl_value);
                                }
                            }
                        });
                    });

                    //remvoe empty row
                    $('#fma-tab1 .form-group').filter(function () {
                        return $(this).children().length == 0;
                    }).hide();

                }
            })
            //tab2 審核
            var param = new Object();
            param.co_code = co_code;
            param.form_id = form_id;
            param.seq_no = seq_no;
            var fmSign = $('#fma-tab2 form');
            $('#tbSignHistory').dataTable().fnDestroy();
            $('#tbSignHistory').dataTable.tables({ visible: true, api: true }).columns.adjust();
            $('#tbSignHistory').dataTable({
                language: lang
            , "lengthMenu": [[3, -1], [3, '全部']]
            , retrieve: true
            , serverSide: true
            , processing: true
            , "paging": true
            , "searching": false
            , 'bSort': false
            , 'aoColumns': [
            { bsearchable: false, bsortable: false, data: 'check_id' },
            { bsearchable: false, bsortable: false, data: 'check_statusc' },
            { bsearchable: false, bsortable: false, data: 'check_time' },
            { bsearchable: false, bsortable: false, data: 'check_remark' }
            ]
            , "info": true
            , ajax: {
                url: '@Url.Action("getSignHistory", "FAdmin")',
                type: 'POST',
                data: param
            }
            , "createdRow": function (row, data, index) {
                var json = JSON.stringifyWcf(data);
                var m2 = JSON.parseWithDate(json);
                $('td', row).eq(2).text(m2.check_time.toLocaleString());
            }
            }).fnDraw();
            //tab3 夾檔 tbAttachFile
            $('#tbAttachFile').dataTable().fnDestroy();
            $('#tbAttachFile').dataTable.tables({ visible: true, api: true }).columns.adjust();
            $('#tbAttachFile').dataTable({
                language: lang
                //, "lengthMenu": [[3, -1], [3, '全部']]
            , retrieve: true
            , serverSide: true
            , processing: true
            , "paging": false
            , "searching": false
            , 'bSort': false
            , 'aoColumns': [
            { bsearchable: false, bsortable: false, data: 'item_no' },
            { bsearchable: false, bsortable: false, data: 'file_name', sWidth: '80%' },
            { bsearchable: false, bsortable: false, data: 'attach_time' }
            ]
            , "info": true
            , ajax: {
                url: '@Url.Action("getAttachfiles", "FAdmin")',
                type: 'POST',
                data: param
            }
            , "createdRow": function (row, data, index) {
                var json = JSON.stringifyWcf(data);
                var m2 = JSON.parseWithDate(json);
                $('td', row).eq(2).text(m2.attach_time.toLocaleString());
                $('td', row).eq(1).text('');
                $('td', row).eq(1).append('<a href=#>' + m2.file_name + '</a>');
            }
            }).fnDraw();
            //tab4 Flow清單
            var imgFlowRightArrow = '<img src="/Content/flow_images/FlowRightArrow.gif">';
            var imgLT = '<img src="/Content/flow_images/FlowR2Arrow.gif">';
            var imgLB = '<img src="/Content/flow_images/FlowR3Arrow.gif">';
            var imgRT = '<img src="/Content/flow_images/FlowR1Arrow.gif">';
            var imgRB = '<img src="/Content/flow_images/FlowR4Arrow.gif">';
            $('#tbFlow').css('margin-top', '20px');
            $('#tbFlow').css('margin-left', '20px');
            $('#tbFlow').find('tbody').empty();
            $.ajax({
                method: 'POST',
                data: { form_id: form_id, co_code: co_code, seq_no: seq_no },
                url: '@Url.Action("getFlowReaderList", "FAdmin")',
                dataType: 'json',
                async: false,
                success: function (r) {
                    //console.log(r.group);
                    $('#tbFlow').find('tbody').append('<tr></tr>');
                    var trNums = $('#tbFlow tr:nth-child(1)');
                    $(trNums).append('<td>關卡數</td><td></td>')
                    for (var i = 0; i < r.items; i++) {
                        var isgroup = true;
                        $.each(r.group, function (idx, gitem) {
                            if ((gitem.cnt > 1) && (gitem.item_no == (i + 1))) {
                                isgroup = true;
                            }
                        });
                        if (isgroup) {
                            $(trNums).append('<td></td><td stage="' + (i + 1) + '">第  ' + (i + 1) + '  關</td><td></td>');
                        }
                        else {
                            $(trNums).append('<td stage="' + (i + 1) + '">第  ' + (i + 1) + '  關</td><tr></td>');
                        }
                    }
                    $(trNums).append('<td></td><td></td>');
                    for (var i = 0; i < r.rows; i++) {
                        $('#tbFlow').find('tbody').append('<tr></tr>');
                        icolcount = $('#tbFlow tbody tr:first-child td').length;
                        while ($('#tbFlow tbody tr:last-child td').length < icolcount) {
                            $('#tbFlow tbody tr:last-child').append('<td></td>');
                        }
                    }
                    $.each(r.data, function (index, item) {
                        var irow = item.item_row + 1;
                        //single
                        if (item.item_row == 0) {
                            irow = 2;
                        }
                            //group first
                        else if (item.item_row == 1) {
                            irow = 1;
                        }
                            //group other
                        else {
                            irow = item.item_row + 1;
                        }
                        var icol = $('#tbFlow tr:first-child td[stage="' + item.item_no + '"]').index();
                        if (irow == 5) {
                            //debugger;
                        }
                        $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').text(item.usr_name);
                        if (irow != 2) {
                            if (irow == 1) {
                                $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').prev().append(imgLT);
                                $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').next().append(imgRT);
                            }
                            else {
                                $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').prev().append(imgLB);
                                $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').next().append(imgRB);
                            }
                            if ($('#tbFlow tr:eq(2) td:eq(' + (icol - 1) + ')').text() == '') {
                                $('#tbFlow tr:eq(2) td:eq(' + (icol - 1) + ')').text('⊕');
                                $('#tbFlow tr:eq(2) td:eq(' + (icol + 1) + ')').text('AND');
                                $('#tbFlow tr:eq(2) td:eq(' + (icol + 2) + ')').append(imgFlowRightArrow);
                            }
                        }
                        else {
                            $('#tbFlow tr:eq(' + irow + ') td:eq(' + icol + ')').append(imgFlowRightArrow);
                        }
                    });
                    //draw arrow
                    $('#tbFlow tbody tr:eq(2) td:eq(0)').text('◎流程開始');
                    $('#tbFlow tbody tr:eq(2) td:eq(1)').append(imgFlowRightArrow);
                    $('#tbFlow tbody tr:eq(2) td:last-child').text('流程結束◎');
                }
            })
            //tab4 tbFlowGrid
            $('#tbFlowGrid th').attr('nowrap', 'nowrap');
            $('#tbFlowGrid th').css('font-size', '9px');
            $('#tbFlowGrid').dataTable().fnDestroy();
            //$('#tbFlowGrid').dataTable.tables({ visible: true, api: true }).columns.adjust();
            $('#tbFlowGrid').dataTable({
                language: lang
                //, "lengthMenu": [[3, -1], [3, '全部']]
            , retrieve: true
            , serverSide: true
            , processing: true
            , "paging": false
            , "searching": false
            , 'bSort': false
            , 'aoColumns': [
            { bsearchable: false, bsortable: false, data: 'item_no' }
            , { bsearchable: false, bsortable: false, data: 'item_statusv' }
            , { bsearchable: false, bsortable: false, data: 'usr_name' }
            , { bsearchable: false, bsortable: false, data: 'dep_name' }
            , { bsearchable: false, bsortable: false, data: 'usr_title' }
            , { bsearchable: false, bsortable: false, data: 'check_statusv' }
            , { bsearchable: false, bsortable: false, data: 'check_time' }
            , { bsearchable: false, bsortable: false, data: 'open_time' }
            , { bsearchable: false, bsortable: false, data: 'check_remark' }
            ]
            , "info": true
            , ajax: {
                url: '@Url.Action("getFlowGrid", "FAdmin")',
                type: 'POST',
                data: param
            }
            , "createdRow": function (row, data, index) {
                var json = JSON.stringifyWcf(data);
                var m2 = JSON.parseWithDate(json);
                $('th').attr('nowrap', 'nowrap');
                $('td', row).attr('nowrap', 'nowrap');
                $('td:last-child', row).removeAttr('nowrap');
                if (m2.check_time != null) {
                    var check_time = moment(m2.check_time).format('YYYY-MM-DD HH:mm:ss');
                    $('td', row).eq(6).text(check_time);
                }
                if (m2.open_time != null) {
                    var open_time = moment(m2.open_time).format('YYYY-MM-DD HH:mm:ss');
                    $('td', row).eq(7).text(open_time);
                }
            }
            }).fnDraw();
            //$("#fma").draggable({
            //    handle: ".modal-header"
            //});
            //$(".dialog").dialog({
            //    autoOpen: false
            //});
            //$('#fma').dialog("open");
            $('#fma').modal({ backdrop: false });
        }
        // NeedApproved bill List
        $('#tba').dataTable.tables({ visible: true, api: true }).columns.adjust();
        $('#tba').dataTable({
            language: lang
        , serverSide: true
        , processing: true
            //, scrollY: 400
        , "scrollCollapse": true
        , "info": true
        , "paging": true
        , ajax: {
            url: '@Url.Action("getBillList","FAdmin")',
            type: 'POST',
            data: param //JSON.stringify(param)
        }
        , "createdRow": function (row, data, index) {
            //if ( data[5].replace(/[\$,]/g, '') * 1 > 150000 ) {
            //    $('td', row).eq(5).addClass('highlight');
            //}
            var json = JSON.stringifyWcf(data);
            var m2 = JSON.parseWithDate(json);
            $('td', row).eq(4).text(m2.receive_time.toLocaleString());
            $('td', row).eq(0).text('').append('<a></a>');
            var a = $('td', row).eq(0).children('a');
            var url = '@Url.Action("getForm", "FAdmin")';
            $(a).attr('form_id', data.form_id).attr('seq_no', data.seq_no)
            .attr('href', '#')
            .text(data.apply_title == '' ? '無標題' : data.apply_title)
            .on('click', function () {
                showSignFormWin(data);
            })

        }
        , 'columns': [
        { sWidth: "20%", bSearchable: false, bSortable: false, data: 'apply_title' }
        , { sWidth: "15%", bSearchable: false, bSortable: false, data: 'form_name' }
        , { sWidth: "20%", bSearchable: false, bSortable: false, data: 'dep_name' }
        , { sWidth: "10%", bSearchable: false, bSortable: false, data: 'usr_name' }
        , { sWidth: "20%", bSearchable: false, bSortable: false, data: 'receive_time' }
        ]
        });
    });
</script>
@*<script type="text/babel" src="~/Scripts/flowcheck.bundle.js">
    </script>*@
